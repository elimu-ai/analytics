package ai.elimu.analytics.task

import ai.elimu.analytics.BaseApplication
import ai.elimu.analytics.BuildConfig
import ai.elimu.analytics.rest.LetterSoundAssessmentEventService
import ai.elimu.analytics.rest.LetterSoundLearningEventService
import ai.elimu.analytics.rest.NumberAssessmentEventService
import ai.elimu.analytics.rest.NumberLearningEventService
import ai.elimu.analytics.rest.StoryBookLearningEventService
import ai.elimu.analytics.rest.VideoLearningEventService
import ai.elimu.analytics.rest.WordAssessmentEventService
import ai.elimu.analytics.rest.WordLearningEventService
import ai.elimu.analytics.util.SharedPreferencesHelper
import android.content.Context
import androidx.work.Worker
import androidx.work.WorkerParameters
import okhttp3.MediaType
import okhttp3.MultipartBody
import okhttp3.RequestBody
import timber.log.Timber
import java.io.File

/**
 * Uploads CSV files previously generated by the [ExportEventsToCsvWorker]
 */
class UploadEventsWorker(context: Context, workerParams: WorkerParameters) :
    Worker(context, workerParams) {
    companion object {
        private const val DIR_LETTER_SOUND_LEARNING_EVENTS = "letter-sound-learning-events"
        private const val DIR_LETTER_SOUND_ASSESSMENT_EVENTS = "letter-sound-assessment-events"
        private const val DIR_WORD_LEARNING_EVENTS = "word-learning-events"
        private const val DIR_WORD_ASSESSMENT_EVENTS = "word-assessment-events"
        private const val DIR_NUMBER_LEARNING_EVENTS = "number-learning-events"
        private const val DIR_NUMBER_ASSESSMENT_EVENTS = "number-assessment-events"
        private const val DIR_STORYBOOK_LEARNING_EVENTS = "storybook-learning-events"
        private const val DIR_VIDEO_LEARNING_EVENTS = "video-learning-events"
    }

    override fun doWork(): Result {
        Timber.i("doWork")

        uploadLetterSoundLearningEvents()
        uploadLetterSoundAssessmentEvents()

        uploadWordLearningEvents()
        uploadWordAssessmentEvents()

        uploadNumberLearningEvents()
        uploadNumberAssessmentEvents()

        uploadStoryBookLearningEvents()

        uploadVideoLearningEvents()

        deleteCsvFilesFromPreviousVersions()
        
        return Result.success()
    }

    private fun deleteCsvFilesFromPreviousVersions() {
        Timber.i("deleteCsvFilesFromPreviousVersions")

        val eventSubDirs = listOf(
            DIR_LETTER_SOUND_LEARNING_EVENTS,
            DIR_LETTER_SOUND_ASSESSMENT_EVENTS,
            DIR_WORD_LEARNING_EVENTS,
            DIR_WORD_ASSESSMENT_EVENTS,
            DIR_NUMBER_LEARNING_EVENTS,
            DIR_NUMBER_ASSESSMENT_EVENTS,
            DIR_STORYBOOK_LEARNING_EVENTS,
            DIR_VIDEO_LEARNING_EVENTS
        )
        val filesDir = applicationContext.filesDir
        val languageDirs = filesDir.listFiles { file ->
            file.isDirectory && file.name.startsWith("lang-")
        } ?: emptyArray()

        for (languageDir in languageDirs) {
            for (eventSubDir in eventSubDirs) {
                val eventsDir = File(languageDir, eventSubDir)
                for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
                    if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_") && csvFile.name.endsWith(".csv")) {
                        val deleted = csvFile.delete()
                        Timber.i("delete ${csvFile.name}: $deleted")
                    }
                }
            }
        }

        Timber.i("deleteCsvFilesFromPreviousVersions complete!")
    }

    // Upload CSV files generated by the current version of the app, e.g:
    //   lang-THA/letter-sound-learning-events/5b7c682a12ecbe2e_4001000_letter-sound-learning-events_2025-07-27.csv
    //   lang-THA/letter-sound-learning-events/5b7c682a12ecbe2e_4001000_letter-sound-learning-events_2025-07-27.csv
    private fun uploadLetterSoundLearningEvents() {
        Timber.i("uploadLetterSoundLearningEvents")

        val languageDir = File(applicationContext.filesDir, "lang-${SharedPreferencesHelper.getLanguage(applicationContext)}")
        val eventsDir = File(languageDir, DIR_LETTER_SOUND_LEARNING_EVENTS)
        Timber.i("eventsDir.exists(): ${eventsDir.exists()}")
        for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
            Timber.i("csvFile: ${csvFile}")

            // Skip files that were not generated by the current app version, e.g. "_4001000_"
            if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_")) {
                continue
            }

            // Prepare upload service
            val baseApplication = applicationContext as BaseApplication
            val retrofit = baseApplication.retrofit
            val uploadService = retrofit.create(LetterSoundLearningEventService::class.java)

            // Prepare upload request
            val requestBody = RequestBody.create(MediaType.parse("multipart/form-data"), csvFile)
            val part = MultipartBody.Part.createFormData("file", csvFile.name, requestBody)
            val call = uploadService.uploadCsvFile(part)
            Timber.i("call.request(): ${call.request()}")

            // Upload file
            val response = call.execute()
            Timber.i("response: $response")
            if (response.isSuccessful) {
                val bodyString = response.body()?.string()
                Timber.i("bodyString: $bodyString")
            } else {
                val errorBodyString = response.errorBody()?.string()
                Timber.e("errorBodyString: $errorBodyString")
            }
        }

        Timber.i("uploadLetterSoundLearningEvents complete!")
    }

    // Upload CSV files generated by the current version of the app, e.g:
    //   lang-THA/letter-sound-assessment-events/5b7c682a12ecbe2e_4001000_letter-sound-assessment-events_2025-07-27.csv
    //   lang-THA/letter-sound-assessment-events/5b7c682a12ecbe2e_4001000_letter-sound-assessment-events_2025-07-27.csv
    private fun uploadLetterSoundAssessmentEvents() {
        Timber.i("uploadLetterSoundAssessmentEvents")

        val languageDir = File(applicationContext.filesDir, "lang-${SharedPreferencesHelper.getLanguage(applicationContext)}")
        val eventsDir = File(languageDir, DIR_LETTER_SOUND_ASSESSMENT_EVENTS)
        Timber.i("eventsDir.exists(): ${eventsDir.exists()}")
        for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
            Timber.i("csvFile: ${csvFile}")

            // Skip files that were not generated by the current app version, e.g. "_4001000_"
            if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_")) {
                continue
            }

            // Prepare upload service
            val baseApplication = applicationContext as BaseApplication
            val retrofit = baseApplication.retrofit
            val uploadService = retrofit.create(LetterSoundAssessmentEventService::class.java)

            // Prepare upload request
            val requestBody = RequestBody.create(MediaType.parse("multipart/form-data"), csvFile)
            val part = MultipartBody.Part.createFormData("file", csvFile.name, requestBody)
            val call = uploadService.uploadCsvFile(part)
            Timber.i("call.request(): ${call.request()}")

            // Upload file
            val response = call.execute()
            Timber.i("response: $response")
            if (response.isSuccessful) {
                val bodyString = response.body()?.string()
                Timber.i("bodyString: $bodyString")
            } else {
                val errorBodyString = response.errorBody()?.string()
                Timber.e("errorBodyString: $errorBodyString")
            }
        }

        Timber.i("uploadLetterSoundAssessmentEvents complete!")
    }


    // Upload CSV files generated by the current version of the app, e.g:
    //   lang-THA/word-learning-events/5b7c682a12ecbe2e_4001000_word-learning-events_2025-07-27.csv
    //   lang-THA/word-learning-events/5b7c682a12ecbe2e_4001000_word-learning-events_2025-07-27.csv
    private fun uploadWordLearningEvents() {
        Timber.i("uploadWordLearningEvents")

        val languageDir = File(applicationContext.filesDir, "lang-${SharedPreferencesHelper.getLanguage(applicationContext)}")
        val eventsDir = File(languageDir, DIR_WORD_LEARNING_EVENTS)
        Timber.i("eventsDir.exists(): ${eventsDir.exists()}")
        for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
            Timber.i("csvFile: ${csvFile}")

            // Skip files that were not generated by the current app version, e.g. "_4001000_"
            if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_")) {
                continue
            }

            // Prepare upload service
            val baseApplication = applicationContext as BaseApplication
            val retrofit = baseApplication.retrofit
            val uploadService = retrofit.create(WordLearningEventService::class.java)

            // Prepare upload request
            val requestBody = RequestBody.create(MediaType.parse("multipart/form-data"), csvFile)
            val part = MultipartBody.Part.createFormData("file", csvFile.name, requestBody)
            val call = uploadService.uploadCsvFile(part)
            Timber.i("call.request(): ${call.request()}")

            // Upload file
            val response = call.execute()
            Timber.i("response: $response")
            if (response.isSuccessful) {
                val bodyString = response.body()?.string()
                Timber.i("bodyString: $bodyString")
            } else {
                val errorBodyString = response.errorBody()?.string()
                Timber.e("errorBodyString: $errorBodyString")
            }
        }

        Timber.i("uploadWordLearningEvents complete!")
    }

    // Upload CSV files generated by the current version of the app, e.g:
    //   lang-THA/word-assessment-events/5b7c682a12ecbe2e_4001000_word-assessment-events_2025-07-27.csv
    //   lang-THA/word-assessment-events/5b7c682a12ecbe2e_4001000_word-assessment-events_2025-07-27.csv
    private fun uploadWordAssessmentEvents() {
        Timber.i("uploadWordAssessmentEvents")

        val languageDir = File(applicationContext.filesDir, "lang-${SharedPreferencesHelper.getLanguage(applicationContext)}")
        val eventsDir = File(languageDir, DIR_WORD_ASSESSMENT_EVENTS)
        Timber.i("eventsDir.exists(): ${eventsDir.exists()}")
        for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
            Timber.i("csvFile: ${csvFile}")

            // Skip files that were not generated by the current app version, e.g. "_4001000_"
            if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_")) {
                continue
            }

            // Prepare upload service
            val baseApplication = applicationContext as BaseApplication
            val retrofit = baseApplication.retrofit
            val uploadService = retrofit.create(WordAssessmentEventService::class.java)

            // Prepare upload request
            val requestBody = RequestBody.create(MediaType.parse("multipart/form-data"), csvFile)
            val part = MultipartBody.Part.createFormData("file", csvFile.name, requestBody)
            val call = uploadService.uploadCsvFile(part)
            Timber.i("call.request(): ${call.request()}")

            // Upload file
            val response = call.execute()
            Timber.i("response: $response")
            if (response.isSuccessful) {
                val bodyString = response.body()?.string()
                Timber.i("bodyString: $bodyString")
            } else {
                val errorBodyString = response.errorBody()?.string()
                Timber.e("errorBodyString: $errorBodyString")
            }
        }

        Timber.i("uploadWordAssessmentEvents complete!")
    }


    // Upload CSV files generated by the current version of the app, e.g:
    //   lang-THA/number-learning-events/5b7c682a12ecbe2e_4000021_number-learning-events_2025-06-29.csv
    //   lang-THA/number-learning-events/5b7c682a12ecbe2e_4000021_number-learning-events_2025-06-30.csv
    private fun uploadNumberLearningEvents() {
        Timber.i("uploadNumberLearningEvents")

        val languageDir = File(applicationContext.filesDir, "lang-${SharedPreferencesHelper.getLanguage(applicationContext)}")
        val eventsDir = File(languageDir, DIR_NUMBER_LEARNING_EVENTS)
        Timber.i("eventsDir.exists(): ${eventsDir.exists()}")
        for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
            Timber.i("csvFile: ${csvFile}")

            // Skip files that were not generated by the current app version, e.g. "_4000021_"
            if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_")) {
                continue
            }

            // Prepare upload service
            val baseApplication = applicationContext as BaseApplication
            val retrofit = baseApplication.retrofit
            val uploadService = retrofit.create(NumberLearningEventService::class.java)

            // Prepare upload request
            val requestBody = RequestBody.create(MediaType.parse("multipart/form-data"), csvFile)
            val part = MultipartBody.Part.createFormData("file", csvFile.name, requestBody)
            val call = uploadService.uploadCsvFile(part)
            Timber.i("call.request(): ${call.request()}")

            // Upload file
            val response = call.execute()
            Timber.i("response: $response")
            if (response.isSuccessful) {
                val bodyString = response.body()?.string()
                Timber.i("bodyString: $bodyString")
            } else {
                val errorBodyString = response.errorBody()?.string()
                Timber.e("errorBodyString: $errorBodyString")
            }
        }

        Timber.i("uploadNumberLearningEvents complete!")
    }
    
    // Upload CSV files generated by the current version of the app, e.g:
    //   lang-THA/number-assessment-events/5b7c682a12ecbe2e_4000021_number-assessment-events_2025-06-29.csv
    //   lang-THA/number-assessment-events/5b7c682a12ecbe2e_4000021_number-assessment-events_2025-06-30.csv
    private fun uploadNumberAssessmentEvents() {
        Timber.i("uploadNumberAssessmentEvents")

        val languageDir = File(applicationContext.filesDir, "lang-${SharedPreferencesHelper.getLanguage(applicationContext)}")
        val eventsDir = File(languageDir, DIR_NUMBER_ASSESSMENT_EVENTS)
        Timber.i("eventsDir.exists(): ${eventsDir.exists()}")
        for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
            Timber.i("csvFile: ${csvFile}")

            // Skip files that were not generated by the current app version, e.g. "_4000021_"
            if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_")) {
                continue
            }

            // Prepare upload service
            val baseApplication = applicationContext as BaseApplication
            val retrofit = baseApplication.retrofit
            val uploadService = retrofit.create(NumberAssessmentEventService::class.java)

            // Prepare upload request
            val requestBody = RequestBody.create(MediaType.parse("multipart/form-data"), csvFile)
            val part = MultipartBody.Part.createFormData("file", csvFile.name, requestBody)
            val call = uploadService.uploadCsvFile(part)
            Timber.i("call.request(): ${call.request()}")

            // Upload file
            val response = call.execute()
            Timber.i("response: $response")
            if (response.isSuccessful) {
                val bodyString = response.body()?.string()
                Timber.i("bodyString: $bodyString")
            } else {
                val errorBodyString = response.errorBody()?.string()
                Timber.e("errorBodyString: $errorBodyString")
            }
        }

        Timber.i("uploadNumberAssessmentEvents complete!")
    }

    
    // Upload CSV files generated by the current version of the app, e.g:
    //   lang-THA/storybook-learning-events/5b7c682a12ecbe2e_4000021_storybook-learning-events_2025-06-29.csv
    //   lang-THA/storybook-learning-events/5b7c682a12ecbe2e_4000021_storybook-learning-events_2025-06-30.csv
    private fun uploadStoryBookLearningEvents() {
        Timber.i("uploadStoryBookLearningEvents")

        val languageDir = File(applicationContext.filesDir, "lang-${SharedPreferencesHelper.getLanguage(applicationContext)}")
        val eventsDir = File(languageDir, DIR_STORYBOOK_LEARNING_EVENTS)
        Timber.i("eventsDir.exists(): ${eventsDir.exists()}")
        for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
            Timber.i("csvFile: ${csvFile}")

            // Skip files that were not generated by the current app version, e.g. "_4000021_"
            if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_")) {
                continue
            }

            // Prepare upload service
            val baseApplication = applicationContext as BaseApplication
            val retrofit = baseApplication.retrofit
            val uploadService = retrofit.create(StoryBookLearningEventService::class.java)

            // Prepare upload request
            val requestBody = RequestBody.create(MediaType.parse("multipart/form-data"), csvFile)
            val part = MultipartBody.Part.createFormData("file", csvFile.name, requestBody)
            val call = uploadService.uploadCsvFile(part)
            Timber.i("call.request(): ${call.request()}")

            // Upload file
            val response = call.execute()
            Timber.i("response: $response")
            if (response.isSuccessful) {
                val bodyString = response.body()?.string()
                Timber.i("bodyString: $bodyString")
            } else {
                val errorBodyString = response.errorBody()?.string()
                Timber.e("errorBodyString: $errorBodyString")
            }
        }

        Timber.i("uploadStoryBookLearningEvents complete!")
    }

    
    // Upload CSV files generated by the current version of the app, e.g:
    //   lang-THA/video-learning-events/5b7c682a12ecbe2e_4000021_video-learning-events_2025-06-29.csv
    //   lang-THA/video-learning-events/5b7c682a12ecbe2e_4000021_video-learning-events_2025-06-30.csv
    private fun uploadVideoLearningEvents() {
        Timber.i("uploadVideoLearningEvents")

        val languageDir = File(applicationContext.filesDir, "lang-${SharedPreferencesHelper.getLanguage(applicationContext)}")
        val eventsDir = File(languageDir, DIR_VIDEO_LEARNING_EVENTS)
        Timber.i("eventsDir.exists(): ${eventsDir.exists()}")
        for (csvFile in eventsDir.listFiles() ?: emptyArray()) {
            Timber.i("csvFile: ${csvFile}")

            // Skip files that were not generated by the current app version, e.g. "_4000021_"
            if (!csvFile.name.contains("_${BuildConfig.VERSION_CODE}_")) {
                continue
            }

            // Prepare upload service
            val baseApplication = applicationContext as BaseApplication
            val retrofit = baseApplication.retrofit
            val uploadService = retrofit.create(VideoLearningEventService::class.java)

            // Prepare upload request
            val requestBody = RequestBody.create(MediaType.parse("multipart/form-data"), csvFile)
            val part = MultipartBody.Part.createFormData("file", csvFile.name, requestBody)
            val call = uploadService.uploadCsvFile(part)
            Timber.i("call.request(): ${call.request()}")

            // Upload file
            val response = call.execute()
            Timber.i("response: $response")
            if (response.isSuccessful) {
                val bodyString = response.body()?.string()
                Timber.i("bodyString: $bodyString")
            } else {
                val errorBodyString = response.errorBody()?.string()
                Timber.e("errorBodyString: $errorBodyString")
            }
        }

        Timber.i("uploadVideoLearningEvents complete!")
    }
}
